import"./hoisted.DV8WBEkX.js";let e=1,t=10,n="all",o="",a="all";async function s(){const s=document.getElementById("loading"),c=document.getElementById("conversations-container");s&&s.classList.remove("hidden"),c&&(c.innerHTML="");try{const d=new URLSearchParams({page:e.toString(),limit:t.toString(),status:n,search:o,searchType:a}),r=await fetch(`/api/chat/conversations?${d}`),l=await r.json();s&&s.classList.add("hidden"),l.success&&l.conversations?(!function(e){const t=document.getElementById("conversations-container");if(!t)return;const n=e.map(e=>`\n    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">\n      <div class="flex items-start justify-between">\n        <div class="flex-1">\n          <div class="flex items-center space-x-3 mb-2">\n            <h3 class="font-semibold text-gray-900">${e.client_name||"Sem nome"}</h3>\n            <span class="px-2 py-1 text-xs rounded-full ${"active"===e.status?"bg-green-100 text-green-800":"completed"===e.status?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}">\n              ${e.status||"N/A"}\n            </span>\n          </div>\n          <div class="text-sm text-gray-600 space-y-1">\n            ${e.client_email?`<div>üìß ${e.client_email}</div>`:""}\n            ${e.client_phone?`<div>üì± ${e.client_phone}</div>`:""}\n            ${e.client_address?`<div>üìç ${e.client_address}</div>`:""}\n          </div>\n          ${e.client_problem?`<div class="mt-2 text-sm text-gray-700"><strong>Problema:</strong> ${e.client_problem}</div>`:""}\n        </div>\n        <div class="flex flex-col items-end space-y-2">\n          <div class="text-right text-sm text-gray-500">\n            <div>ID: ${e.id}</div>\n            <div>${new Date(e.created_at).toLocaleDateString("pt-BR")}</div>\n            <div>${new Date(e.created_at).toLocaleTimeString("pt-BR")}</div>\n          </div>\n          \x3c!-- Bot√µes de A√ß√£o --\x3e\n          <div class="flex space-x-2">\n            <button onclick="viewConversation('${e.session_id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="Ver conversa">\n              üëÅÔ∏è Ver\n            </button>\n            <button onclick="editConversation('${e.session_id}', '${e.client_name||""}', '${e.client_email||""}', '${e.client_phone||""}', '${(e.client_problem||"").replace(/'/g,"&apos;")}')") class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="Editar">\n              ‚úèÔ∏è Editar\n            </button>\n            <button onclick="toggleStatus('${e.session_id}', '${e.status}')" class="${"active"===e.status?"bg-orange-500 hover:bg-orange-600":"bg-green-500 hover:bg-green-600"} text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="${"active"===e.status?"Marcar como inativo":"Marcar como ativo"}">\n              ${"active"===e.status?"‚è∏Ô∏è Inativar":"‚ñ∂Ô∏è Ativar"}\n            </button>\n            <button onclick="deleteConversation('${e.session_id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-xs font-medium transition-colors" title="Excluir">\n              üóëÔ∏è Excluir\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  `).join("");t.innerHTML=n}(l.conversations),function(e){const t=document.getElementById("showing-from"),n=document.getElementById("showing-to"),o=document.getElementById("total-items");t&&(t.textContent=e.from||0);n&&(n.textContent=e.to||0);o&&(o.textContent=e.total||0)}(l.pagination),function(e){const t=document.getElementById("total-conversations");t&&(t.textContent=e||0)}(l.pagination.total),i()):(c&&(c.innerHTML='<div class="text-center py-8 text-gray-500">Nenhuma conversa encontrada.</div>'),i())}catch(d){const e=document.getElementById("loading"),t=document.getElementById("conversations-container");e&&e.classList.add("hidden"),t&&(t.innerHTML=`<div class="text-center py-8 text-red-500">Erro ao carregar conversas: ${d.message}<br><button onclick="loadConversations()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Tentar Novamente</button></div>`)}}function i(){const e=document.getElementById("search-indicator"),t=document.getElementById("search-term"),n=document.getElementById("search-field");if(o&&o.trim()){const s={all:"todos os campos",name:"nome do cliente",email:"email",phone:"telefone",problem:"problema/descri√ß√£o",content:"conte√∫do das mensagens"};t&&(t.textContent=o),n&&(n.textContent=s[a]||"todos os campos"),e&&e.classList.remove("hidden")}else e&&e.classList.add("hidden")}function c(){const t=document.getElementById("search-input"),n=document.getElementById("search-type");t&&n&&(o=t.value.trim(),a=n.value,e=1,s())}function d(){const t=document.getElementById("search-input"),n=document.getElementById("search-type");t&&(t.value=""),n&&(n.value="all"),o="",a="all",e=1,s()}document.addEventListener("DOMContentLoaded",function(){const i=document.getElementById("search-input"),r=document.getElementById("search-type");i&&(i.value=""),r&&(r.value="all"),o="",a="all",e=1;const l=document.getElementById("search-btn"),m=document.getElementById("clear-search-btn"),u=document.getElementById("remove-search"),v=document.getElementById("status-filter"),g=document.getElementById("limit-filter"),p=document.getElementById("refresh-btn");l&&l.addEventListener("click",c),m&&m.addEventListener("click",d),u&&u.addEventListener("click",d),i&&i.addEventListener("keypress",function(e){"Enter"===e.key&&c()}),r&&r.addEventListener("change",function(){const e={all:"Digite o termo de busca...",name:"Digite o nome do cliente...",email:"Digite o email...",phone:"Digite o telefone...",problem:"Digite palavras do problema...",content:"Digite palavras das mensagens..."};i&&(i.placeholder=e[this.value]||"Digite o termo de busca...")}),v&&v.addEventListener("change",function(){n=this.value,e=1,s()}),g&&g.addEventListener("change",function(){t=parseInt(this.value),e=1,s()}),p&&p.addEventListener("click",function(){s()});const y=document.getElementById("close-modal"),h=document.getElementById("conversation-modal");y&&y.addEventListener("click",function(){h&&h.classList.add("hidden")});const E=document.getElementById("close-edit-modal"),f=document.getElementById("edit-modal"),x=document.getElementById("cancel-edit");E&&E.addEventListener("click",function(){f&&f.classList.add("hidden")}),x&&x.addEventListener("click",function(){f&&f.classList.add("hidden")});const b=document.getElementById("edit-form");b&&b.addEventListener("submit",async function(e){e.preventDefault();const t=document.getElementById("edit-session-id").value,n=document.getElementById("edit-client-name").value,o=document.getElementById("edit-client-email").value,a=document.getElementById("edit-client-phone").value,i=document.getElementById("edit-client-problem").value;try{const e=await fetch("/api/chat/edit-conversation",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:t,client_name:n,client_email:o,client_phone:a,client_problem:i})}),c=await e.json();c.success?(f&&f.classList.add("hidden"),s()):alert("Erro ao editar conversa: "+c.error)}catch(c){alert("Erro ao editar conversa")}}),s()}),window.viewConversation=async function(e){try{const n=await fetch(`/api/chat/conversation/${e}`),o=await n.json();if(o.success&&o.conversation){const e=o.conversation;if(e){const n=document.getElementById("conversation-modal"),o=document.getElementById("modal-title"),a=document.getElementById("modal-content");if(o&&(o.textContent=`Conversa: ${e.client_name||"Sem nome"}`),a){let n=[];try{if(e.messages)if("string"==typeof e.messages){const t=e.messages.replace(/^"|"$/g,"").replace(/\\"/g,'"');n=JSON.parse(t)}else n=e.messages}catch(t){n=[{content:"Erro ao carregar mensagens da conversa",timestamp:(new Date).toISOString(),type:"system"}]}a.innerHTML=`\n            <div class="mb-4 p-4 bg-gray-50 rounded-lg">\n              <h3 class="font-semibold text-gray-900 mb-2">Informa√ß√µes do Cliente:</h3>\n              <div class="grid grid-cols-2 gap-4 text-sm">\n                <div><strong>Nome:</strong> ${e.client_name||"N/A"}</div>\n                <div><strong>Email:</strong> ${e.client_email||"N/A"}</div>\n                <div><strong>Telefone:</strong> ${e.client_phone||"N/A"}</div>\n                <div><strong>Status:</strong> ${e.status||"N/A"}</div>\n              </div>\n              ${e.client_problem?`<div class="mt-2"><strong>Problema:</strong> ${e.client_problem}</div>`:""}\n            </div>\n            <div class="space-y-4">\n              <h3 class="font-semibold text-gray-900">Hist√≥rico da Conversa:</h3>\n              ${n.map(e=>`\n                <div class="${"user"===e.type?"text-right":"text-left"}">\n                  <div class="inline-block max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${"user"===e.type?"bg-blue-500 text-white":"system"===e.type?"bg-red-100 text-red-800":"bg-gray-200 text-gray-800"}">\n                    <p class="text-sm">${e.content}</p>\n                    <p class="text-xs mt-1 opacity-75">${new Date(e.timestamp).toLocaleString("pt-BR")}</p>\n                  </div>\n                </div>\n              `).join("")}\n            </div>\n          `}n&&n.classList.remove("hidden")}else alert("Conversa n√£o encontrada")}else alert("Erro ao carregar conversa")}catch(n){alert("Erro ao carregar conversa: "+n.message)}},window.editConversation=async function(e,t,n,o,a){try{if(void 0!==t){const s=document.getElementById("edit-modal"),i=document.getElementById("edit-session-id"),c=document.getElementById("edit-client-name"),d=document.getElementById("edit-client-email"),r=document.getElementById("edit-client-phone"),l=document.getElementById("edit-client-problem");return i&&(i.value=e),c&&(c.value=t),d&&(d.value=n),r&&(r.value=o),l&&(l.value=a.replace(/&apos;/g,"'")),void(s&&s.classList.remove("hidden"))}const s=await fetch(`/api/chat/conversations?search=${e}&searchType=all`),i=await s.json();if(i.success&&i.conversations&&i.conversations.length>0){const t=i.conversations.find(t=>t.session_id===e);if(t){const e=document.getElementById("edit-modal"),n=document.getElementById("edit-session-id"),o=document.getElementById("edit-client-name"),a=document.getElementById("edit-client-email"),s=document.getElementById("edit-client-phone"),i=document.getElementById("edit-client-problem");n&&(n.value=t.session_id),o&&(o.value=t.client_name||""),a&&(a.value=t.client_email||""),s&&(s.value=t.client_phone||""),i&&(i.value=t.client_problem||""),e&&e.classList.remove("hidden")}else alert("Conversa n√£o encontrada para edi√ß√£o")}else alert("Erro ao carregar conversa para edi√ß√£o: "+(i.error||"Conversa n√£o encontrada"))}catch(s){alert("Erro ao carregar conversa: "+s.message)}},window.toggleStatus=async function(e,t){const n="active"===t?"completed":"active";try{const t=await fetch("/api/chat/toggle-status",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:e,status:n})}),o=await t.json();o.success?s():alert("Erro ao alterar status: "+o.error)}catch(o){alert("Erro ao alterar status")}},window.deleteConversation=async function(e){let t="esta conversa";try{const n=await fetch(`/api/chat/conversations?search=${e}&searchType=all`),o=await n.json();if(o.success&&o.conversations&&o.conversations.length>0){const n=o.conversations.find(t=>t.session_id===e);n&&(t=`a conversa de ${n.client_name||"cliente sem nome"} (ID: ${n.id})`)}}catch(n){}if(confirm(`Tem certeza que deseja excluir ${t}?\n\nEsta a√ß√£o n√£o pode ser desfeita e todos os dados da conversa ser√£o perdidos permanentemente.`))try{const t=await fetch(`/api/chat/delete-conversation?sessionId=${e}`,{method:"DELETE"}),n=await t.json();n.success?(alert("Conversa exclu√≠da com sucesso!"),s()):alert("Erro ao excluir conversa: "+(n.error||"Erro desconhecido"))}catch(o){alert("Erro ao excluir conversa: "+o.message)}};
