/**
 * Teste do Sistema de Threat Intelligence
 * Demonstra a detec√ß√£o e enriquecimento de eventos com dados de amea√ßas conhecidas
 */

import threatIntelligence from './src/utils/threatIntelligence.js';

async function testThreatIntelligence() {
    console.log('üî¨ === TESTE DO SISTEMA DE THREAT INTELLIGENCE ===\n');
    
    // Aguardar inicializa√ß√£o
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    console.log('üìä Estat√≠sticas iniciais:');
    const initialStats = threatIntelligence.getThreatStats();
    console.log(JSON.stringify(initialStats, null, 2));
    console.log();
    
    // Teste 1: Verifica√ß√£o de IP malicioso conhecido
    console.log('üß™ TESTE 1: Verifica√ß√£o de IP malicioso conhecido');
    console.log('=' .repeat(50));
    
    const maliciousIP = '198.51.100.10';
    const ipResult = await threatIntelligence.checkIPReputation(maliciousIP);
    
    if (ipResult) {
        console.log(`‚úÖ IP ${maliciousIP} identificado como amea√ßa:`);
        console.log(`   Categoria: ${ipResult.category}`);
        console.log(`   Severidade: ${ipResult.severity}`);
        console.log(`   Confian√ßa: ${ipResult.confidence}`);
        console.log(`   Risk Score: ${ipResult.riskScore}`);
        console.log(`   Fonte: ${ipResult.source}`);
    } else {
        console.log(`‚ùå IP ${maliciousIP} n√£o encontrado como amea√ßa`);
    }
    console.log();
    
    // Teste 2: Verifica√ß√£o de IP limpo
    console.log('üß™ TESTE 2: Verifica√ß√£o de IP limpo');
    console.log('=' .repeat(50));
    
    const cleanIP = '8.8.8.8';
    const cleanResult = await threatIntelligence.checkIPReputation(cleanIP);
    
    if (cleanResult) {
        console.log(`‚ö†Ô∏è IP ${cleanIP} identificado como amea√ßa (falso positivo?)`);
    } else {
        console.log(`‚úÖ IP ${cleanIP} est√° limpo`);
    }
    console.log();
    
    // Teste 3: Verifica√ß√£o de dom√≠nio malicioso
    console.log('üß™ TESTE 3: Verifica√ß√£o de dom√≠nio malicioso');
    console.log('=' .repeat(50));
    
    const maliciousDomain = 'malicious-site.example';
    const domainResult = await threatIntelligence.checkDomainReputation(maliciousDomain);
    
    if (domainResult) {
        console.log(`‚úÖ Dom√≠nio ${maliciousDomain} identificado como amea√ßa:`);
        console.log(`   Categoria: ${domainResult.category}`);
        console.log(`   Severidade: ${domainResult.severity}`);
        console.log(`   Confian√ßa: ${domainResult.confidence}`);
        console.log(`   Risk Score: ${domainResult.riskScore}`);
    } else {
        console.log(`‚ùå Dom√≠nio ${maliciousDomain} n√£o encontrado como amea√ßa`);
    }
    console.log();
    
    // Teste 4: Verifica√ß√£o de hash malicioso
    console.log('üß™ TESTE 4: Verifica√ß√£o de hash malicioso');
    console.log('=' .repeat(50));
    
    const maliciousHash = 'a1b2c3d4e5f6789012345678901234567890abcd';
    const hashResult = await threatIntelligence.checkHashReputation(maliciousHash);
    
    if (hashResult) {
        console.log(`‚úÖ Hash ${maliciousHash} identificado como amea√ßa:`);
        console.log(`   Categoria: ${hashResult.category}`);
        console.log(`   Severidade: ${hashResult.severity}`);
        console.log(`   Confian√ßa: ${hashResult.confidence}`);
        console.log(`   Risk Score: ${hashResult.riskScore}`);
    } else {
        console.log(`‚ùå Hash ${maliciousHash} n√£o encontrado como amea√ßa`);
    }
    console.log();
    
    // Teste 5: Enriquecimento de evento de seguran√ßa simples
    console.log('üß™ TESTE 5: Enriquecimento de evento simples');
    console.log('=' .repeat(50));
    
    const simpleEvent = {
        type: 'login_attempt',
        severity: 'medium',
        client_ip: '203.0.113.45', // IP scanner conhecido
        user_agent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)',
        message: 'Failed login attempt',
        timestamp: new Date(),
        details: {
            username: 'admin',
            attempts: 5
        }
    };
    
    const enrichedSimple = await threatIntelligence.enrichSecurityEvent(simpleEvent);
    
    console.log(`üìä Evento original: ${simpleEvent.type} (${simpleEvent.severity})`);
    console.log(`üìà Risk Score: ${enrichedSimple.riskScore.toFixed(3)}`);
    console.log(`üéØ Indicadores encontrados: ${enrichedSimple.threatIndicators.length}`);
    
    if (enrichedSimple.threatIndicators.length > 0) {
        enrichedSimple.threatIndicators.forEach(indicator => {
            console.log(`   ‚Ä¢ ${indicator}`);
        });
        
        console.log(`üìã Recomenda√ß√µes:`);
        enrichedSimple.recommendations.forEach(rec => {
            console.log(`   ‚Ä¢ ${rec}`);
        });
        
        console.log(`üîç Contexto:`);
        if (enrichedSimple.context.attackPatterns.length > 0) {
            console.log(`   Padr√µes de ataque: ${enrichedSimple.context.attackPatterns.join(', ')}`);
        }
        if (enrichedSimple.context.mitreTactics.length > 0) {
            console.log(`   MITRE ATT&CK: ${enrichedSimple.context.mitreTactics.join(', ')}`);
        }
    }
    console.log();
    
    // Teste 6: Enriquecimento de evento complexo com m√∫ltiplas amea√ßas
    console.log('üß™ TESTE 6: Enriquecimento de evento complexo');
    console.log('=' .repeat(50));
    
    const complexEvent = {
        type: 'file_upload',
        severity: 'low',
        client_ip: '192.0.2.100', // IP malware conhecido
        user_agent: 'curl/7.68.0',
        message: 'Suspicious file upload detected',
        timestamp: new Date(),
        details: {
            filename: 'malware.exe',
            filesize: 1024000,
            hash: 'a1b2c3d4e5f6789012345678901234567890abcd', // Hash malicioso conhecido
            destination: '/uploads/',
            referrer: 'https://phishing-bank.example/download', // Dom√≠nio malicioso
            upload_path: '/var/www/uploads/malware.exe'
        }
    };
    
    const enrichedComplex = await threatIntelligence.enrichSecurityEvent(complexEvent);
    
    console.log(`üìä Evento original: ${complexEvent.type} (${complexEvent.severity})`);
    console.log(`üìà Risk Score: ${enrichedComplex.riskScore.toFixed(3)}`);
    console.log(`üî• Severidade final: ${enrichedComplex.finalSeverity}`);
    console.log(`üéØ Indicadores encontrados: ${enrichedComplex.threatIndicators.length}`);
    
    if (enrichedComplex.threatIndicators.length > 0) {
        console.log(`\nüö® AMEA√áAS DETECTADAS:`);
        enrichedComplex.threatIndicators.forEach((indicator, index) => {
            console.log(`   ${index + 1}. ${indicator}`);
        });
        
        console.log(`\nüìã RECOMENDA√á√ïES DE RESPOSTA:`);
        enrichedComplex.recommendations.forEach((rec, index) => {
            console.log(`   ${index + 1}. ${rec}`);
        });
        
        console.log(`\nüîç CONTEXTO DE AMEA√áA:`);
        if (enrichedComplex.context.attackPatterns.length > 0) {
            console.log(`   Padr√µes de ataque: ${enrichedComplex.context.attackPatterns.join(', ')}`);
        }
        if (enrichedComplex.context.mitreTactics.length > 0) {
            console.log(`   MITRE ATT&CK Tactics: ${enrichedComplex.context.mitreTactics.join(', ')}`);
        }
        
        // Mostrar detalhes das amea√ßas encontradas
        if (enrichedComplex.threatIntelligence.ip) {
            console.log(`\nüåê Threat Intelligence - IP:`);
            console.log(`   IP: ${complexEvent.client_ip}`);
            console.log(`   Categoria: ${enrichedComplex.threatIntelligence.ip.category}`);
            console.log(`   Confian√ßa: ${enrichedComplex.threatIntelligence.ip.confidence}`);
            console.log(`   Fonte: ${enrichedComplex.threatIntelligence.ip.source}`);
        }
        
        if (enrichedComplex.threatIntelligence.domains) {
            console.log(`\nüåç Threat Intelligence - Dom√≠nios:`);
            enrichedComplex.threatIntelligence.domains.forEach(domainInfo => {
                console.log(`   Dom√≠nio: ${domainInfo.domain}`);
                console.log(`   Categoria: ${domainInfo.threat.category}`);
                console.log(`   Confian√ßa: ${domainInfo.threat.confidence}`);
            });
        }
        
        if (enrichedComplex.threatIntelligence.hashes) {
            console.log(`\nüîê Threat Intelligence - Hashes:`);
            enrichedComplex.threatIntelligence.hashes.forEach(hashInfo => {
                console.log(`   Hash: ${hashInfo.hash}`);
                console.log(`   Categoria: ${hashInfo.threat.category}`);
                console.log(`   Confian√ßa: ${hashInfo.threat.confidence}`);
            });
        }
    }
    console.log();
    
    // Teste 7: Cache e performance
    console.log('üß™ TESTE 7: Teste de cache e performance');
    console.log('=' .repeat(50));
    
    console.log('üîÑ Primeira consulta (sem cache):');
    const start1 = Date.now();
    await threatIntelligence.checkIPReputation('198.51.100.10');
    const time1 = Date.now() - start1;
    console.log(`   Tempo: ${time1}ms`);
    
    console.log('üîÑ Segunda consulta (com cache):');
    const start2 = Date.now();
    await threatIntelligence.checkIPReputation('198.51.100.10');
    const time2 = Date.now() - start2;
    console.log(`   Tempo: ${time2}ms`);
    
    console.log(`üìä Melhoria de performance: ${((time1 - time2) / time1 * 100).toFixed(1)}%`);
    console.log();
    
    // Teste 8: Top amea√ßas
    console.log('üß™ TESTE 8: Top amea√ßas conhecidas');
    console.log('=' .repeat(50));
    
    const topThreats = threatIntelligence.getTopThreats(5);
    console.log(`üèÜ Top ${topThreats.length} amea√ßas por confian√ßa:`);
    
    topThreats.forEach((threat, index) => {
        console.log(`   ${index + 1}. ${threat.type.toUpperCase()}: ${threat.value}`);
        console.log(`      Categoria: ${threat.category} | Confian√ßa: ${threat.confidence} | Fonte: ${threat.source}`);
    });
    console.log();
    
    // Teste 9: Simula√ß√£o de atualiza√ß√£o de feeds
    console.log('üß™ TESTE 9: Atualiza√ß√£o de feeds de threat intelligence');
    console.log('=' .repeat(50));
    
    console.log('üîÑ Simulando atualiza√ß√£o de feeds...');
    await threatIntelligence.updateThreatFeeds();
    console.log();
    
    // Estat√≠sticas finais
    console.log('üìä ESTAT√çSTICAS FINAIS:');
    console.log('=' .repeat(50));
    
    const finalStats = threatIntelligence.getThreatStats();
    console.log(`üåê IPs maliciosos em cache: ${finalStats.ipCache.malicious}`);
    console.log(`üåç Dom√≠nios maliciosos em cache: ${finalStats.domainCache.malicious}`);
    console.log(`üîê Hashes maliciosos em cache: ${finalStats.hashCache.malicious}`);
    console.log(`üì° Feeds ativos: ${finalStats.feeds.enabled}/${finalStats.feeds.total}`);
    
    console.log('\n‚úÖ === TESTE DE THREAT INTELLIGENCE CONCLU√çDO ===');
    console.log('\nüî¨ O sistema demonstrou capacidade de:');
    console.log('   ‚Ä¢ Detectar IPs, dom√≠nios e hashes maliciosos');
    console.log('   ‚Ä¢ Enriquecer eventos de seguran√ßa com contexto de amea√ßas');
    console.log('   ‚Ä¢ Calcular risk scores e escalar severidade automaticamente');
    console.log('   ‚Ä¢ Fornecer recomenda√ß√µes de resposta baseadas em threat intelligence');
    console.log('   ‚Ä¢ Mapear amea√ßas para frameworks como MITRE ATT&CK');
    console.log('   ‚Ä¢ Utilizar cache para otimizar performance');
    console.log('   ‚Ä¢ Simular integra√ß√£o com feeds externos de threat intelligence');
}

// Executar teste
testThreatIntelligence().catch(console.error);